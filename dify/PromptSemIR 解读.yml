app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: PromptSemIR è§£è¯»
  use_icon_as_answer_icon: false
dependencies: []
kind: app
version: 0.5.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_batch_limit: 10
        image_file_size_limit: 10
        single_chunk_attachment_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: code
      id: 1766973434726-source-1766973467441-target
      source: '1766973434726'
      sourceHandle: source
      target: '1766973467441'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: end
      id: 1766973467441-source-1766973497585-target
      source: '1766973467441'
      sourceHandle: source
      target: '1766973497585'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: ç”¨æˆ·è¾“å…¥
        type: start
        variables:
        - default: ''
          hint: ''
          label: promptsemir_json
          max_length: 1024000
          options: []
          placeholder: ''
          required: true
          type: paragraph
          variable: promptsemir_json
      height: 109
      id: '1766973434726'
      position:
        x: 80
        y: 282
      positionAbsolute:
        x: 80
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\n\ndef main(promptsemir_json: str) -> dict:\n    \"\"\"\
          \n    å°† PromptSemIR JSON è½¬æ¢ä¸ºä¸¥æ ¼ç»“æ„åŒ–çš„ä¸­è‹±å¯¹ç…§ Markdown æŠ¥å‘Šã€‚\n    æ›´æ–°ç‚¹ï¼š\n    1. æœ¯è¯­æ˜ å°„æ›´æ–°ï¼šæ˜¾å¼ç¡®ä¿¡/éšå¼ç¡®ä¿¡/æ¨æ–­/è§„åˆ’å»ºè®®ã€‚\n\
          \    2. å¢åŠ å®Œæ•´çš„å¯ä¿¡åº¦å›¾ä¾‹è¯´æ˜ã€‚\n    \"\"\"\n    \n    # 1. è§£æ JSON\n    data = {}\n\
          \    if isinstance(promptsemir_json, dict):\n        data = promptsemir_json\n\
          \    else:\n        try:\n            data = json.loads(promptsemir_json)\n\
          \        except:\n            return {\"report_markdown\": \"Error: è¾“å…¥ä¸æ˜¯æœ‰æ•ˆçš„\
          \ JSON æ ¼å¼ã€‚\"}\n\n    lines = []\n\n    # ================= è¾…åŠ©å‡½æ•° =================\n\
          \n    def safe_get(obj, path_str, default=None):\n        \"\"\"å®‰å…¨è·å–åµŒå¥—å­—å…¸å€¼\"\
          \"\"\n        keys = path_str.split('.')\n        current = obj\n      \
          \  for k in keys:\n            if isinstance(current, dict):\n         \
          \       current = current.get(k)\n            else:\n                return\
          \ default\n        return current if current is not None else default\n\n\
          \    def trans_origin(origin):\n        \"\"\"æ¥æºæœ¯è¯­ç¿»è¯‘ (æ ¹æ®ç”¨æˆ·å®šä¹‰æ›´æ–°)\"\"\"\n\
          \        mapping = {\n            \"explicit\": \"æ˜¾å¼ç¡®ä¿¡ (explicit)\",\n \
          \           \"entailed\": \"éšå¼ç¡®ä¿¡ (entailed)\",\n            \"inferred\"\
          : \"LLMçš„æ¨æ–­ (inferred)\",\n            \"projected\": \"è§„åˆ’å»ºè®® (projected)\"\
          \n        }\n        return mapping.get(origin, origin)\n\n    def render_value(val):\n\
          \        \"\"\"æ¸²æŸ“å€¼ï¼šå¤„ç†å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å¯¹è±¡åˆ—è¡¨(æ¸…å•æ ¼å¼)\"\"\"\n        if val is None or\
          \ val == \"\" or val == [] or val == {}:\n            return \"æ— \"\n   \
          \     \n        # 1. å¯¹è±¡åˆ—è¡¨ï¼ˆå¦‚å˜é‡è¡¨ï¼‰ï¼šè½¬ä¸º 1. **name** (type): desc æ ¼å¼\n       \
          \ if isinstance(val, list) and len(val) > 0 and isinstance(val[0], dict):\n\
          \            list_lines = []\n            for idx, item in enumerate(val,\
          \ 1):\n                name = item.get('name', 'N/A')\n                typ\
          \ = item.get('type')\n                desc = item.get('description')\n \
          \               \n                if 'name' in item:\n                 \
          \   type_str = f\" ({typ})\" if typ else \"\"\n                    desc_str\
          \ = f\"ï¼š{desc}\" if desc else \"\"\n                    \n             \
          \       extras = []\n                    for k, v in item.items():\n   \
          \                     if k not in ['name', 'type', 'description']:\n   \
          \                         extras.append(f\"{k}={v}\")\n                \
          \    extras_str = f\" [{', '.join(extras)}]\" if extras else \"\"\n    \
          \                \n                    line = f\"{idx}. **{name}**{type_str}{desc_str}{extras_str}\"\
          \n                    list_lines.append(line)\n                else:\n \
          \                   clean_json = json.dumps(item, ensure_ascii=False)\n\
          \                    list_lines.append(f\"{idx}. {clean_json}\")\n     \
          \       \n            return \"\\n\" + \"\\n\".join(list_lines)\n\n    \
          \    # 2. æ™®é€šåˆ—è¡¨\n        if isinstance(val, list):\n            return \"\
          \\n\" + \"\\n\".join([f\"- {str(v)}\" for v in val])\n        \n       \
          \ # 3. å­—ç¬¦ä¸²/æ•°å­—\n        return f\"{val}\"\n\n    def render_field(title_cn,\
          \ title_en, field_obj, is_derived=False):\n        \"\"\"æ¸²æŸ“å•ä¸ªè¯­ä¹‰å­—æ®µå—\"\"\"\
          \n        header = f\"#### {title_cn} ({title_en})\"\n        \n       \
          \ if not field_obj:\n            return f\"{header}\\n> **å†…å®¹**ï¼šæ— \\n\"\n\
          \        \n        value = field_obj.get(\"value\")\n        origin = field_obj.get(\"\
          origin\", \"æœªçŸ¥\")\n        evidence = field_obj.get(\"evidence_snippets\"\
          , [])\n        \n        # æ ¸å¿ƒå†…å®¹\n        content_block = f\"> **æ¥æº**ï¼š{trans_origin(origin)}\\\
          n> **å†…å®¹**ï¼š{render_value(value)}\"\n        \n        # æ¨æ–­å±‚ç‰¹æœ‰å­—æ®µ\n       \
          \ if is_derived:\n            rationale = field_obj.get(\"rationale\", \"\
          æ— \")\n            confidence = field_obj.get(\"confidence\", \"N/A\")\n\
          \            content_block += f\"\\n> **æ¨æ–­ç†ç”±**ï¼š{rationale}\\n> **ç½®ä¿¡åº¦**ï¼š{confidence}\"\
          \n\n        # è¯æ®å±•ç¤º\n        ev_block = \"\"\n        if evidence:\n    \
          \        snippets = [f\"â€œ{s}â€\" for s in evidence]\n            ev_str =\
          \ \"; \".join(snippets)\n            if len(ev_str) > 100: ev_str = ev_str[:100]\
          \ + \"...\"\n            ev_block = f\"\\n> **è¯æ®**ï¼š{ev_str}\"\n        else:\n\
          \            # åªæœ‰ projected å…è®¸æ— è¯æ®ï¼Œå…¶ä»–æ˜¾ç¤ºæ— \n            if origin == \"projected\"\
          :\n                ev_block = \"\" # å»ºè®®ç±»ä¿¡æ¯å¯ä»¥ä¸æ˜¾ç¤ºâ€œè¯æ®ï¼šæ— â€ä»¥ä¿æŒæ•´æ´ï¼Œæˆ–è€…æ˜¾ç¤ºâ€œåŸºäºä¸“å®¶çŸ¥è¯†â€\n\
          \            else:\n                ev_block = \"\\n> **è¯æ®**ï¼šæ— \"\n     \
          \       \n        return f\"{header}\\n{content_block}{ev_block}\\n\"\n\n\
          \    # ================= æŠ¥å‘Šç”Ÿæˆé€»è¾‘ =================\n\n    # 1. æ ‡é¢˜ä¸å…ƒæ•°æ®\n \
          \   meta = data.get(\"meta\", {})\n    semir_id = meta.get(\"semir_id\"\
          , \"N/A\")\n    status = meta.get(\"lifecycle_status\", \"N/A\").upper()\n\
          \    \n    lines.append(f\"# PromptSemIR èµ„äº§è§£è¯»æŠ¥å‘Š\")\n    lines.append(f\"\
          **èµ„äº§ID**: `{semir_id}`\")\n    lines.append(f\"**ç”Ÿå‘½å‘¨æœŸçŠ¶æ€**: **{status}**\"\
          )\n    lines.append(f\"**åˆ›å»ºæ—¶é—´**: {meta.get('created_at', 'N/A')}\")\n  \
          \  lines.append(\"---\")\n\n    # 2. åŸå§‹æç¤ºè¯\n    lines.append(\"## 1. åŸå§‹æç¤ºè¯\
          \ (Source Prompt)\")\n    source = data.get(\"source_prompt\", {})\n   \
          \ raw = source.get(\"raw\", \"\")\n    \n    if raw:\n        lines.append(f\"\
          > **åŸå§‹æ–‡æœ¬å…¨é‡å±•ç¤º**ï¼š\\n```text\\n{raw}\\n```\")\n    else:\n        lines.append(f\"\
          > **åŸå§‹æ–‡æœ¬**ï¼šæ— \")\n        \n    lines.append(f\"> **Canonical Hash**: `{safe_get(source,\
          \ 'hashes.canonical_sha256', 'N/A')}`\")\n    lines.append(\"---\")\n\n\
          \    # 3. ç¼–è¯‘ä¸Šä¸‹æ–‡\n    lines.append(\"## 2. ç¼–è¯‘ä¸Šä¸‹æ–‡ (Compilation Context)\"\
          )\n    ctx = data.get(\"compilation_context\", {})\n    vars_snap = safe_get(ctx,\
          \ \"vars_snapshot.data\")\n    enhance_snap = safe_get(ctx, \"enhance_case_snapshot.data\"\
          )\n    \n    lines.append(f\"- **å˜é‡å¿«ç…§ (Vars Snapshot)**: {render_value(vars_snap)}\"\
          )\n    lines.append(f\"- **å¢å¼ºç”¨ä¾‹å¿«ç…§ (Enhance Case)**: {render_value(enhance_snap)}\"\
          )\n    lines.append(\"---\")\n\n    # 4. æ ¸å¿ƒè¯­ä¹‰å±‚\n    lines.append(\"## 3.\
          \ æ ¸å¿ƒè¯­ä¹‰å±‚ (Core Semantics)\")\n    \n    # æ’å…¥å›¾ä¾‹è¯´æ˜\n    lines.append(\"> **\U0001F4A1\
          \ æ•°æ®å¯ä¿¡åº¦å›¾ä¾‹**ï¼š\")\n    lines.append(\"> * **æ˜¾å¼ç¡®ä¿¡ (explicit)**ï¼šåŸæ–‡ç›´æ¥å†™æ˜çš„æ–‡å­—ã€‚\"\
          )\n    lines.append(\"> * **éšå¼ç¡®ä¿¡ (entailed)**ï¼šåŸæ–‡æœªç›´æ¥å†™æ˜ï¼Œä½†é€»è¾‘ä¸Šå¿…ç„¶åŒ…å«çš„äº‹å®ã€‚\")\n\
          \    lines.append(\"> * **æ¨æ–­ (inferred)**ï¼šLLMåŸºäºæ¦‚ç‡æŒ–æ˜çš„ä¿¡æ¯ï¼ˆé™„ç½®ä¿¡åº¦ï¼‰ã€‚\")\n    lines.append(\"\
          > * **è§„åˆ’å»ºè®® (projected)**ï¼šLLMåŸºäºä¸“å®¶çŸ¥è¯†å¯¹æœªæ¥çš„ä¼˜åŒ–å»ºè®®ï¼ˆéåŸæ–‡å†…å®¹ï¼‰ã€‚\")\n    lines.append(\"\
          \")\n\n    sem = data.get(\"promptSem\", {})\n    core = sem.get(\"core_semantics\"\
          , {})\n    \n    core_map = [\n        (\"è§’è‰²\", \"role\"),\n        (\"\
          æ„å›¾\", \"intent\"),\n        (\"æ˜¾å¼å˜é‡\", \"variables_explicit\"),\n      \
          \  (\"çº¦æŸæ¡ä»¶\", \"constraints\"),\n        (\"è¾“å‡ºè§„èŒƒ\", \"output_spec\")\n \
          \   ]\n    for cn, en in core_map:\n        lines.append(render_field(cn,\
          \ en, core.get(en)))\n    \n    lines.append(\"---\")\n\n    # 5. æ¨æ–­è¯­ä¹‰å±‚\n\
          \    lines.append(\"## 4. æ¨æ–­è¯­ä¹‰å±‚ (Derived Semantics)\")\n    derived = sem.get(\"\
          derived_semantics\", {})\n    \n    derived_map = [\n        (\"éšå¼å˜é‡\",\
          \ \"implicit_variables\"),\n        (\"å‡è®¾\", \"assumptions\"),\n       \
          \ (\"æ¨æ–­çº¦æŸ\", \"inferred_constraints\")\n    ]\n    for cn, en in derived_map:\n\
          \        lines.append(render_field(cn, en, derived.get(en), is_derived=True))\n\
          \n    lines.append(\"---\")\n\n    # 6. å¢å¼ºè®¡åˆ’å±‚\n    lines.append(\"## 5.\
          \ å¢å¼ºè®¡åˆ’å±‚ (Augmentation Plan)\")\n    aug = sem.get(\"augmentation_plan\"\
          , {})\n    \n    aug_map = [\n        (\"å»ºè®®ç¤ºä¾‹\", \"suggested_examples\"\
          ),\n        (\"é¡¹ç›®æ€§å»ºè®®\", \"projected_output_schema\"),\n        (\"ç¨³å®šæ€§æ”¹è¿›\"\
          , \"stability_improvements\")\n    ]\n    for cn, en in aug_map:\n     \
          \   lines.append(render_field(cn, en, aug.get(en)))\n\n    lines.append(\"\
          ---\")\n\n    # 7. è¿è¡Œä¸éªŒè¯\n    lines.append(\"## 6. è¿è¡Œä¸éªŒè¯ (Runs & Validation)\"\
          )\n    \n    val_rep = data.get(\"validation_report\", {})\n    test_info\
          \ = val_rep.get(\"test\", {})\n    \n    lines.append(f\"- **ç¼–è¯‘çŠ¶æ€ (Compile\
          \ Status)**: `{val_rep.get('compile', {}).get('status', 'N/A')}`\")\n  \
          \  lines.append(f\"- **é”šç‚¹çŠ¶æ€ (Anchor Status)**: `{val_rep.get('anchors',\
          \ {}).get('status', 'N/A')}`\")\n    lines.append(f\"- **æµ‹è¯•çŠ¶æ€ (Test Status)**:\
          \ `{test_info.get('status', 'N/A')}`\")\n    if test_info.get('status')\
          \ == 'not_run':\n        lines.append(f\"  > *è¯´æ˜ï¼šMVPé˜¶æ®µæµ‹è¯•æœªæ‰§è¡Œ ({test_info.get('summary',\
          \ '')})*\")\n\n    warnings = val_rep.get(\"compile\", {}).get(\"warnings\"\
          , []) + val_rep.get(\"anchors\", {}).get(\"warnings\", [])\n    if warnings:\n\
          \        lines.append(f\"\\n**è­¦å‘Šåˆ—è¡¨ ({len(warnings)})**ï¼š\")\n        for\
          \ w in warnings:\n            lines.append(f\"- {w}\")\n    else:\n    \
          \    lines.append(f\"\\n**è­¦å‘Šåˆ—è¡¨**ï¼šæ— \")\n\n    lines.append(\"---\")\n\n \
          \   # 8. äººå·¥ä¿®è®¢\n    lines.append(\"## 7. äººå·¥ä¿®è®¢ (Human Overrides)\")\n    human\
          \ = data.get(\"human_overrides\", {})\n    patches = human.get(\"patches\"\
          , [])\n    audit = human.get(\"audit\")\n\n    if not patches:\n       \
          \ lines.append(\"**ä¿®è®¢è¡¥ä¸ (Patches)**ï¼šæ— \")\n    else:\n        lines.append(f\"\
          **ä¿®è®¢è¡¥ä¸ (Patches)**ï¼šå…± {len(patches)} æ¡\")\n        for p in patches:\n  \
          \          lines.append(f\"- `{p.get('op')}` path: `{p.get('path')}`\")\n\
          \    \n    if audit:\n        lines.append(f\"\\n**å®¡æ ¸ä¿¡æ¯ (Audit)**ï¼š\\n- å®¡æ ¸äººï¼š{audit.get('reviewed_by')}\\\
          n- æ—¶é—´ï¼š{audit.get('reviewed_at')}\\n- å¤‡æ³¨ï¼š{audit.get('notes')}\")\n\n    return\
          \ {\n        \"report_markdown\": \"\\n\".join(lines)\n    }"
        code_language: python3
        outputs:
          report_markdown:
            children: null
            type: string
        selected: true
        title: ä»£ç æ‰§è¡Œ
        type: code
        variables:
        - value_selector:
          - '1766973434726'
          - promptsemir_json
          value_type: string
          variable: promptsemir_json
      height: 52
      id: '1766973467441'
      position:
        x: 382
        y: 282
      positionAbsolute:
        x: 382
        y: 282
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        outputs:
        - value_selector:
          - '1766973467441'
          - report_markdown
          value_type: string
          variable: human_report_md
        selected: false
        title: è¾“å‡º
        type: end
      height: 88
      id: '1766973497585'
      position:
        x: 684
        y: 282
      positionAbsolute:
        x: 684
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: 139.64891211369348
      y: 106.26216813548331
      zoom: 0.5743491774985174
  rag_pipeline_variables: []
